
# -----------------------
# VARIABLER och LISTOR
# -----------------------

import random


kortlek = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29,
           30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56,
           57, 58, 59, 60]

sakhög = []



player_1_intervals = [6, 12, 18, 24, 30, 36, 42, 48, 54, 60]
player_2_intervals = [6, 12, 18, 24, 30, 36, 42, 48, 54, 60]
player_3_intervals = [6, 12, 18, 24, 30, 36, 42, 48, 54, 60]
player_4_intervals = [6, 12, 18, 24, 30, 36, 42, 48, 54, 60]

player_intervals = [player_1_intervals, player_2_intervals, player_3_intervals, player_4_intervals]

player_1_min_intervals = [1, 7, 13, 19, 25, 31, 37, 43, 49, 55]
player_2_min_intervals = [1, 7, 13, 19, 25, 31, 37, 43, 49, 55]
player_3_min_intervals = [1, 7, 13, 19, 25, 31, 37, 43, 49, 55]
player_4_min_intervals = [1, 7, 13, 19, 25, 31, 37, 43, 49, 55]



player_intervals_min = [player_1_min_intervals, player_2_min_intervals, player_3_min_intervals, player_4_min_intervals]

gi_min = [1, 7, 13, 19, 25, 31, 37, 43, 49, 55]
gi_max = [6, 12, 18, 24, 30, 36, 42, 48, 54, 60]

player_1_gk = [False, False, False, False, False, False, False, False, False, False,]
player_2_gk = [False, False, False, False, False, False, False, False, False, False,]
player_3_gk = [False, False, False, False, False, False, False, False, False, False,]
player_4_gk = [False, False, False, False, False, False, False, False, False, False,]

players_gk = [player_1_gk, player_2_gk, player_3_gk, player_4_gk]

player_1 = []
player_2 = []
player_3 = []
player_4 = []

alla_spelare = [player_1, player_2, player_3, player_4]



spelare_namn = input("Ange namn på alla spelare: ")
spelare_namn = spelare_namn.split(', ')



antal_spelare = len(spelare_namn)
aktiva_spelare = alla_spelare[:antal_spelare]



alla_poäng = [0, 0, 0, 0]
aktiva_poäng = alla_poäng[:antal_spelare]



alla_vinster = [0, 0, 0, 0]
aktiva_vinster = alla_vinster[:antal_spelare]

alla_racko = [0, 0, 0, 0]
aktiva_racko = alla_racko[:antal_spelare]

active_player_intervals_min = player_intervals_min[:antal_spelare]

active_player_intervals = player_intervals[:antal_spelare]

active_players_gk = players_gk[:antal_spelare]

p1_bytt = 0
p2_bytt = 0
p3_bytt = 0
p4_bytt = 0

alla_byten = [p1_bytt, p2_bytt, p3_bytt, p4_bytt]
aktiva_byten = alla_byten[:antal_spelare]



# -------------------
# FUNKTIONER
# -------------------



def blanda_kort(hög):
    random.shuffle(hög)
    return hög

def blanda_kort_igen():
    behåll_kort = sakhög[-1]

    for x in sakhög:
        kortlek.append(x)

    sakhög.clear()

    blanda_kort(kortlek)
    sakhög.append(behåll_kort), kortlek.remove(behåll_kort)

    return kortlek and sakhög

def visa_kort(hand):
    for kort in hand:
        print(10 - hand.index(kort), ":", kort)



def kortutdelning(alla_spelare, lek, sakhög):
    blanda_kort(lek)
    for spelare in alla_spelare:
        for _ in range(10):
            kort = lek.pop(0)
            spelare.append(kort)
    sakhög.append(lek.pop(0))
    return alla_spelare

def nya_kortutdelning(spelare, lek, hög):
    for k in range(len(spelare)):
        spelare[k].clear()

    lek.clear()
    for i in range(1, 61):
        lek.append(i)

    hög.clear()
    return lek and hög



def poäng_bricka(spelare):
    poäng = 5
    for i in range(0, 9):
        if spelare[i] < spelare[i + 1]:
            poäng += 5
        elif spelare[i] > spelare[i + 1]:
            break
    return poäng

def Special_Racko(x):
    if x > 6:
        x = 6
    bonuspoäng = 50 * (2 ** (x - 3))
    return bonuspoäng

def Räkna_Poäng(aktiva_poäng, spelare, aktiva_spelare):
    for tur in range(len(aktiva_spelare)):
        # separat för spelaren som vann:
        poäng = aktiva_poäng[tur]
        if aktiva_spelare[tur] == spelare:
            poäng += 25
            count = 1
            consecutive_runs_list = []
            for i in range(9):
                if spelare[i + 1] == spelare[i] + 1:
                    count += 1
                else:
                    consecutive_runs_list.append(count)
                    count = 1
            highest_consecutive = max(consecutive_runs_list)
            if highest_consecutive >= 3:
                poäng += Special_Racko(highest_consecutive)
        poäng += poäng_bricka(aktiva_spelare[tur])
        aktiva_poäng[tur] = poäng



def spelrunda(spelare, kortlek, sakhög):
    # visa_kort(spelare)
    print(spelare)
    print("Sakhög:", sakhög[-1])

    val = (input("Ta upp? ja/nej: "))
    if val == "ja" or val == "Ja":
        byta = int(input("Byta (index): "))
        spelare.insert(byta - 1, sakhög.pop(-1))
        sakhög.append(spelare.pop(byta))
        print(spelare)
        print("\n\n")


    elif val == "nej" or val == "Nej":
        print("\n")
        print("Kortlek:", kortlek[0], " ", "Sakhög:", sakhög[-1])
        val = (input("Behålla ja/nej: "))

        if val == "ja" or val == "Ja":
            byta = int(input("Byta (index): "))
            spelare.insert(byta - 1, kortlek.pop(0))
            sakhög.append(spelare.pop(byta))
            print(spelare, "\n", "\n")
            print("")

        elif val == "nej" or val == "Nej":
            sakhög.append(kortlek.pop(0))
            print("")

    elif val == "vinn":
        spelare.sort()
        print("")



def intervall_min(intervals):
    i_min = []
    i_min.append(1)
    for i in range(1, 10):
        i_min.append(intervals[i - 1] + 1)
    return i_min

def Adjust_Interval(approved_cards, intervals):
    approved_cards_stripped = []

    min_val = 1
    max_val = 60

    for approved_card in approved_cards:
        if approved_card != False:
            if approved_card == approved_cards[0]:
                min_val = approved_card
                intervals[0] = approved_card
            elif approved_card == approved_cards[-1]:
                max_val = approved_card

            approved_cards_stripped.append(approved_card)

    if not approved_cards_stripped:
        intervals = [6, 12, 18, 24, 30, 36, 42, 48, 54, 60]
        i_min = [1, 7, 13, 19, 25, 31, 37, 43, 49, 55]
        return intervals, i_min

    for i, card in enumerate(approved_cards): 
        if card is False:
            continue
        intervals[i] = card 
        length = i
        position = i
        if i > 0:
            prev_card = approved_cards[i - 1]
            prev_length = i - 1
        else:
            prev_card = None
            prev_length = None

        if card == approved_cards[0]:
            for interval in range(1, position):
                range_val = card - min_val
                jump = max(1, range_val // max(1, length))
                intervals[interval] = (min_val - 1) + jump
                min_val += jump
            min_val = card

        else:
            if prev_card is not None:
                min_val = approved_cards[prev_length]
                for interval in range(position - prev_length - 1):
                    range_val = card - min_val - 1
                    jump = max(1, range_val // max(1, (length - prev_length - 1))) 
                    intervals[prev_length + 1 + interval] = min_val + jump
                    min_val += jump + 1 

        if card == approved_cards[-1]:
            length = i
            card = max_val
            intervals[-1] = card
            for interval in range(9 - position):
                range_val = card - min_val
                jump = max(1, range_val // max(1, (9 - length))) 
                intervals[position + 1 + interval] = min_val + jump
                min_val += jump + 1
                length += 1

    for i in range(1, len(intervals)):
        if intervals[i] <= intervals[i - 1]:
            intervals[i] = intervals[i - 1] + 1

    i_min = [1] + [val + 1 for val in intervals[:-1]]
    return intervals, i_min

def intervall_check2(spelare, max, min):
    godkända_kort = []
    for k in range(10):
        if min[k] <= spelare[k] <= max[k]:
            godkända_kort.append(spelare[k])
        else:
            godkända_kort.append(False)
    return godkända_kort

def intervall_check(spelare):
    godkända_kort = []
    for k in range(0, 10):
        if gi_min[k] <= spelare[k] <= gi_max[k]:
            godkända_kort.append(spelare[k])
        else:
            godkända_kort.append(False)

    return godkända_kort



def gi(gk, spelare):
    swaps = aktiva_byten[tur]

    #kollar sakhögen
    """
    # [0] < [1]
    if gk[0] == False and gk[1] != False and (sakhög[-1] < spelare[1]):
        gk.pop(0), gk.insert(0, sakhög[-1])
        sakhög.append(spelare[0]), spelare.pop(0)
        spelare.insert(0, sakhög[-2]), sakhög.pop(-2)
        #print(spelare[0],"1","sakhög 1")
        swaps += 1
        aktiva_byten[tur] = swaps
        return spelare 

    # [8] < [9]
    elif gk[9] == False and gk[8] != False and (sakhög[-1] > spelare[8]):
        gk.pop(9), gk.insert(9, sakhög[-1])
        sakhög.append(spelare[9]), spelare.pop(9)
        spelare.insert(9, sakhög[-2]), sakhög.pop(-2)
        #print(spelare[9],"10","sakhög 2")
        swaps += 1
        aktiva_byten[tur] = swaps
        return spelare
    """

    for j in range(len(spelare)):
        if gk[j] == False and gi_min[j] <= sakhög[-1] <= gi_max[j]:
            sakhög.append(spelare[j]), spelare.pop(j)
            spelare.insert(j, sakhög[-2]), sakhög.pop(-2)
            #print(spelare[j],j+1,"sakhög 3")
            swaps += 1
            aktiva_byten[tur] = swaps
            return spelare

    """  
    #kollar kortleken
    # [0] < [1]
    if gk[0] == False and gk[1] != False and (kortlek[0] < spelare[1]):
        gk.pop(0), gk.insert(0, kortlek[0])
        sakhög.append(spelare[0]), spelare.pop(0)
        spelare.insert(0, kortlek[0]), kortlek.pop(0)
        #print(spelare[0],"1","kortlek 1")
        swaps += 1
        aktiva_byten[tur] = swaps
        return spelare 

    # [8] < [9]
    elif gk[9] == False and gk[8] != False and (kortlek[0] > spelare[8]):
        gk.pop(9), gk.insert(9, kortlek[0])
        sakhög.append(spelare[9]), spelare.pop(9)
        spelare.insert(9, kortlek[0]), kortlek.pop(0)
        #print(spelare[9],"10","kortlek 2")
        swaps += 1
        aktiva_byten[tur] = swaps
        return spelare
    """

    for k in range(len(spelare)):
        if gk[k] == False and gi_min[k] <= kortlek[0] <= gi_max[k]:
            sakhög.append(spelare[k]), spelare.pop(k)
            spelare.insert(k, kortlek[0]), kortlek.pop(0)
            #print(spelare[k],k+1,"kortlek 3")
            swaps += 1
            aktiva_byten[tur] = swaps
            return spelare 

    #print("botten byter inget")
    sakhög.append(kortlek[0]), kortlek.pop(0)
    return spelare

def ai(gk, spelare,  min, max):
    swaps = aktiva_byten[tur]

    # kollar sakhögen
    for j in range(10):
        if min[j] <= sakhög[-1] <= max[j] and not gk[j]:
                
                discarded_card = spelare.pop(j)     
                new_card = sakhög.pop(-1)          
                spelare.insert(j, new_card)         
                sakhög.append(discarded_card)       
                
                swaps += 1
                aktiva_byten[tur] = swaps
                print("AI tog från sakhögen")
                return spelare

    # kollar kortleken
    for j in range(10):
        if min[j] <= kortlek[0] <= max[j]:
            if gk[j] == False:
                
                discarded_card = spelare.pop(j)     
                new_card = kortlek.pop(0)            
                spelare.insert(j, new_card)          
                sakhög.append(discarded_card)        
                
                swaps += 1
                aktiva_byten[tur] = swaps
                print("AI tog från kortleken")
                return spelare
                
    print("AI byter inget")
    sakhög.append(kortlek.pop(0))
    return spelare

def ai2(spelare,gk):
    swaps = aktiva_byten[tur]

    for i in range(len(spelare)):
        if not gk[i] and abs(sakhög[-1]-((i+1)*6)) < 6:
            sakhög.append(spelare[i]), spelare.pop(i)
            spelare.insert(i, sakhög[-2]), sakhög.pop(-2)
            #print(spelare[j],j+1,"sakhög 3")
            swaps += 1
            aktiva_byten[tur] = swaps
            return spelare

    for i in range(len(spelare)):
         if not gk[i] and abs(kortlek[0]-((i+1)*6)) < 6:
            sakhög.append(spelare[k]), spelare.pop(k)
            spelare.insert(k, kortlek[0]), kortlek.pop(0)
            #print(spelare[k],k+1,"kortlek 3")
            swaps += 1
            aktiva_byten[tur] = swaps  

    sakhög.append(kortlek.pop(0))
    return spelare



def consecutive(spelare):
    count = 1
    consecutive_runs_list = []

    for i in range(9):
        if spelare[i + 1] == spelare[i] + 1:
            count += 1
        else:
            consecutive_runs_list.append(count)
            count = 1

    highest_consecutive = max(consecutive_runs_list)

    return highest_consecutive

def poäng_check(spelare):
    for poäng in spelare:
        if poäng >= 500:
            return True

    return False

def racko_check(spelare):
    for x in spelare:
        if x == sorted(x):
            return True

    return False

def antal_vinster(aktiva_poäng):
    for tur in range(len(aktiva_spelare)):
        vinster = aktiva_vinster[tur]
        if aktiva_poäng[tur] >= 500:
            vinster += 1
            aktiva_vinster[tur] = vinster
            break

def antal_racko(spelare):
    for x in spelare:
        racko = aktiva_racko[tur]
        if x == sorted(x):
            racko += 1
            aktiva_racko[tur] = racko
            break



# -------------------
# SJÄLVA SPELET
# -------------------



aktiva_spelare = kortutdelning(aktiva_spelare, kortlek, sakhög)

for k in range(2):
    antal_omblandningar = 0
    rounds = 0
    omgång = 0

    print("\n--------------------------------------------------------\n")
    print(k + 1)

    if poäng_check(aktiva_poäng):
        for tur in range(len(aktiva_spelare)):
            aktiva_poäng[tur] = 0

    while not poäng_check(aktiva_poäng):

        while not racko_check(aktiva_spelare):
            for tur in range(len(aktiva_spelare)):
                rounds += 1
                
                active_players_gk[tur] = intervall_check2(aktiva_spelare[tur], active_player_intervals[tur], active_player_intervals_min[tur])
                active_player_intervals[tur], active_player_intervals_min[tur] = Adjust_Interval(active_players_gk[tur], active_player_intervals[tur])
                # intervall_check2(aktiva_spelare[tur], active_player_intervals[tur], active_player_intervals_min[tur])

                print("\n",spelare_namn[tur])

                if len(kortlek) == 1:   #byta till 0 så fort inte kortlek[0] ska printas
                    blanda_kort_igen()
                    #print("\nkortleken blandas\n")
                    antal_omblandningar += 1

                elif spelare_namn[tur] == "gi":
                    print(aktiva_spelare[tur],sakhög[-1],kortlek[0])
                    print(intervall_check2(aktiva_spelare[tur], active_player_intervals[tur], active_player_intervals_min[tur]))
                    print(" ")
                    gi(intervall_check(aktiva_spelare[tur]),aktiva_spelare[tur])
                    print(aktiva_spelare[tur],sakhög[-1],kortlek[0])
                    print(intervall_check2(aktiva_spelare[tur], active_player_intervals[tur], active_player_intervals_min[tur]))

                elif spelare_namn[tur] == "ai":
                    print("Before AI:\n ", aktiva_spelare[tur])
                    print("gk:", intervall_check2(aktiva_spelare[tur], active_player_intervals[tur], active_player_intervals_min[tur]))
                    print("max:", active_player_intervals[tur])
                    print("min:", active_player_intervals_min[tur])
                    print("")
                    print("sakhög:", sakhög[-1], "kortlek:", kortlek[0])
                    print(" ")
                    ai(active_players_gk[tur] , aktiva_spelare[tur],active_player_intervals_min[tur], active_player_intervals[tur])
                    print("After AI", aktiva_spelare[tur])
                    print("gk:", intervall_check2(aktiva_spelare[tur], active_player_intervals[tur], active_player_intervals_min[tur]))
                    print("max:", active_player_intervals[tur])
                    print("min:", active_player_intervals_min[tur])
                    print("")

                elif spelare_namn[tur] == "ai2":
                    ai2(aktiva_spelare[tur],intervall_check2(aktiva_spelare[tur], active_player_intervals[tur], active_player_intervals_min[tur]))

                if aktiva_spelare[tur] == sorted(aktiva_spelare[tur]):
                    if spelare_namn[tur] == "risk" and consecutive(aktiva_spelare[tur]) >= 3:
                        Räkna_Poäng(aktiva_poäng, aktiva_spelare[tur], aktiva_spelare)
                        antal_racko(aktiva_spelare)
                        break
                    else:
                        pass
                    #print(spelare_namn[tur],"fick Rack-O")
                    Räkna_Poäng(aktiva_poäng, aktiva_spelare[tur], aktiva_spelare)
                    antal_racko(aktiva_spelare)
                    break

        if racko_check(aktiva_spelare):
            nya_kortutdelning(aktiva_spelare, kortlek, sakhög)
            #print("ny kortutdelning")
            aktiva_spelare = kortutdelning(aktiva_spelare, kortlek, sakhög)
            omgång += 1


    # det man ser i terminalen efter varje iteration

    antal_vinster(aktiva_poäng)
    #for tur in range(len(aktiva_spelare)):
        #print(f"{spelare_namn[tur]:<8} {aktiva_poäng[tur]:<8} {aktiva_vinster[tur]:<8} {aktiva_racko[tur]:<8} {aktiva_byten[tur]:<8}")

    #print("\n", rounds // (antal_spelare * omgång), antal_omblandningar)
print("\n----------------------------------------------------------------------------------------\n")



# det man ser i terminalen i slutet
print("Spelet har avslutats efter",k+1,"iterationer och här är resultaten.\n")
print(f"{"namn":<13} {"antal vinster":<18} {"antal rack-o":<16} {"antal kort som bytes ut":<18}")
for tur in range(len(aktiva_spelare)):
    print(f"{spelare_namn[tur]:<18} {aktiva_vinster[tur]:<18} {aktiva_racko[tur]:<21} {aktiva_byten[tur]:<18}")
print(abs(aktiva_byten[0]-aktiva_byten[1]))
print("\n----------------------------------------------------------------------------------------\n")